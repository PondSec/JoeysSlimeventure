[gd_scene load_steps=2 format=3 uid="uid://ie0sg54ff2s8"]

[sub_resource type="GDScript" id="GDScript_ctekh"]
script/source = "extends PopupPanel

@onready var receiver_id_input = $VBoxContainer/LineEdit
@onready var item_select = $VBoxContainer/OptionButton
@onready var confirm_button = $VBoxContainer/Button
@onready var error_label = $VBoxContainer/Label
@onready var background = $Background

var player_node: Node

func _ready():
	# Style für die UI-Elemente setzen
	set_styles()
	
	confirm_button.pressed.connect(self._on_confirm_pressed)
	receiver_id_input.gui_input.connect(_on_input_gui_input)
	refresh_item_list()

func set_styles():
	# Beispiel für Custom Styles - füge entsprechende Texturen in deinem Projekt hinzu
	var panel_style = StyleBoxTexture.new()
	panel_style.texture = preload(\"res://Assets/GUI/TextBox.png\")
	panel_style.expand_margin_left = 10
	panel_style.expand_margin_right = 10
	panel_style.expand_margin_top = 10
	panel_style.expand_margin_bottom = 10
	self.add_theme_stylebox_override(\"panel\", panel_style)
	
	var button_style = StyleBoxFlat.new()
	button_style.bg_color = Color(\"#3a5a78\")
	button_style.corner_radius_top_left = 5
	button_style.corner_radius_top_right = 5
	button_style.corner_radius_bottom_right = 5
	button_style.corner_radius_bottom_left = 5
	confirm_button.add_theme_stylebox_override(\"normal\", button_style)
	
	var hover_style = button_style.duplicate()
	hover_style.bg_color = Color(\"#4a7a98\")
	confirm_button.add_theme_stylebox_override(\"hover\", hover_style)

func _on_input_gui_input(event):
	# Verhindert, dass die E-Taste andere Aktionen auslöst
	if event is InputEventKey and event.pressed:
		if event.keycode == KEY_E:
			get_viewport().set_input_as_handled()

func refresh_item_list():
	item_select.clear()
	
	if not player_node or not player_node.inv:
		return
	
	var item_index = 0
	for slot in player_node.inv.slots:
		if slot.item and slot.amount > 0:
			var display_name = slot.item.name.replace(\"_\", \" \").capitalize()
			# Füge ein Icon hinzu, falls vorhanden
			var icon = load(\"res://assets/items/%s.png\" % slot.item.name) if ResourceLoader.exists(\"res://assets/items/%s.png\" % slot.item.name) else null
			item_select.add_icon_item(icon, \"%s (%d)\" % [display_name, slot.amount], item_index)
			item_index += 1

func _on_confirm_pressed():
	var receiver_id = receiver_id_input.text.strip_edges()
	var selected_index = item_select.get_selected_id()
	
	if receiver_id.is_empty():
		show_error(\"Bitte Empfänger-ID eingeben\")
		return
	
	if selected_index == -1:
		show_error(\"Bitte ein Item auswählen\")
		return
	
	var actual_slot_index = 0
	var selected_item_slot = null
	for slot in player_node.inv.slots:
		if slot.item and slot.amount > 0:
			if actual_slot_index == selected_index:
				selected_item_slot = slot
				break
			actual_slot_index += 1
	
	if not selected_item_slot:
		show_error(\"Ungültiges Item ausgewählt\")
		return
	
	var item_name = selected_item_slot.item.name
	player_node.send_item_to_player(receiver_id, item_name)
	
	selected_item_slot.amount -= 1
	if selected_item_slot.amount <= 0:
		selected_item_slot.item = null
	
	player_node.inv.update.emit()
	refresh_item_list()
	hide()
	# Erfolgs-Sound abspielen
	#AudioManager.play_sound(\"success\")

func show_error(message: String):
	error_label.text = message
	error_label.visible = true
	# Fehler-Sound abspielen
	#AudioManager.play_sound(\"error\")
	# Timer, um die Fehlermeldung nach 3 Sekunden auszublenden
	get_tree().create_timer(3.0).timeout.connect(func(): error_label.visible = false)
"

[node name="Transfer" type="PopupPanel"]
mode = 3
title = "Transfer Item"
size = Vector2i(100, 125)
visible = true
script = SubResource("GDScript_ctekh")

[node name="VBoxContainer" type="VBoxContainer" parent="."]
offset_left = 4.0
offset_top = 4.0
offset_right = 96.0
offset_bottom = 121.0

[node name="LineEdit" type="LineEdit" parent="VBoxContainer"]
layout_mode = 2

[node name="OptionButton" type="OptionButton" parent="VBoxContainer"]
layout_mode = 2

[node name="Button" type="Button" parent="VBoxContainer"]
layout_mode = 2
text = "Bestätigen"

[node name="Label" type="Label" parent="VBoxContainer"]
layout_mode = 2
